# .github/workflows/ci-release.yml

name: CI and Release

on:
  push:
    branches:
      - '**'
    tags:
      - 'v*'
  pull_request:
    branches:
      - '**'

env:
  APP_NAME: plainpad

jobs:
  build-test:
    name: Build and Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: swatinem/rust-cache@v2

      - name: Rust Format (cargo fmt)
        run: cargo fmt --all -- --check

      - name: Rust Lints (cargo clippy)
        run: cargo clippy --all-targets -- -D warnings

      - name: Rust Tests
        run: cargo test --all --no-fail-fast

      - name: Rust Build (release)
        run: cargo build --release

      - name: Package binary (unix)
        if: startsWith(github.ref, 'refs/tags/v') && runner.os != 'Windows'
        shell: bash
        run: |
          if [ "${{ runner.os }}" = "Linux" ]; then
            os="linux"
            arch="x64"
          else
            os="macos"
            arch="x64"
            if [ "${{ runner.arch }}" = "ARM64" ]; then
              arch="aarch64"
            fi
          fi
          cp "target/release/${APP_NAME}" "${APP_NAME}-${os}-${arch}"

      - name: Package binary (windows)
        if: startsWith(github.ref, 'refs/tags/v') && runner.os == 'Windows'
        shell: pwsh
        run: |
          $arch = if ("${{ runner.arch }}" -eq "ARM64") { "aarch64" } else { "x64" }
          Copy-Item "target/release/${{ env.APP_NAME }}.exe" "${{ env.APP_NAME }}-windows-$arch.exe"

      - name: Upload Rust binary artifact
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v6
        with:
          name: ${{ env.APP_NAME }}-${{ runner.os }}-${{ runner.arch }}
          path: ${{ env.APP_NAME }}-*

  linux-arm64:
    name: Linux aarch64 (cross)
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu

      - name: Install cross
        run: cargo install cross --locked

      - name: Build (linux aarch64)
        run: cross build --release --target aarch64-unknown-linux-gnu

      - name: Package binary (linux aarch64)
        run: cp target/aarch64-unknown-linux-gnu/release/${{ env.APP_NAME }} ${{ env.APP_NAME }}-linux-aarch64

      - name: Upload binary (linux aarch64)
        uses: actions/upload-artifact@v6
        with:
          name: ${{ env.APP_NAME }}-linux-aarch64
          path: ${{ env.APP_NAME }}-linux-aarch64

  macos-arm64:
    name: macOS aarch64 (native)
    runs-on: macos-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Build (macos aarch64)
        run: cargo build --release --target aarch64-apple-darwin

      - name: Package binary (macos aarch64)
        run: cp target/aarch64-apple-darwin/release/${{ env.APP_NAME }} ${{ env.APP_NAME }}-macos-aarch64

      - name: Upload binary (macos aarch64)
        uses: actions/upload-artifact@v6
        with:
          name: ${{ env.APP_NAME }}-macos-aarch64
          path: ${{ env.APP_NAME }}-macos-aarch64

  windows-arm64:
    name: Windows aarch64 (cross)
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-pc-windows-msvc

      - name: Set up MSVC for ARM64
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: amd64_arm64

      - name: Build (windows aarch64)
        run: cargo build --release --target aarch64-pc-windows-msvc

      - name: Package binary (windows aarch64)
        shell: pwsh
        run: Copy-Item "target/aarch64-pc-windows-msvc/release/${{ env.APP_NAME }}.exe" "${{ env.APP_NAME }}-windows-aarch64.exe"

      - name: Upload binary (windows aarch64)
        uses: actions/upload-artifact@v6
        with:
          name: ${{ env.APP_NAME }}-windows-aarch64
          path: ${{ env.APP_NAME }}-windows-aarch64.exe

  windows-installer:
    name: Windows Installer (Velopack)
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: swatinem/rust-cache@v2

      - name: Build (release)
        run: cargo build --release

      - name: Get version from tag
        id: get-version
        shell: bash
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Install Velopack CLI
        run: dotnet tool install -g vpk

      - name: Create Velopack Release
        run: |
          vpk pack `
            --packId "Plainpad" `
            --packVersion "${{ steps.get-version.outputs.version }}" `
            --packDir "target/release" `
            --mainExe "plainpad.exe" `
            --packTitle "Plainpad" `
            --shortcuts "Desktop,StartMenuRoot"

      - name: Upload Velopack artifacts
        uses: actions/upload-artifact@v6
        with:
          name: velopack-windows
          path: Releases/*

  release:
    name: Release on tag
    runs-on: ubuntu-latest
    needs:
      - build-test
      - linux-arm64
      - macos-arm64
      - windows-arm64
      - windows-installer
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "*"
          merge-multiple: true

      - name: List downloaded artifacts
        run: |
          echo "=== All files in current directory ==="
          ls -la
          echo "=== Looking for Velopack files ==="
          find . -name "*.nupkg" -o -name "Setup.exe" -o -name "RELEASES" 2>/dev/null || true

      - name: Create checksums
        run: |
          for f in ${APP_NAME}-*; do
            if [ -f "$f" ]; then
              sha256sum "$f" > "$f.sha256"
            fi
          done
          # Checksums for Velopack files
          for f in Setup.exe RELEASES Plainpad-*.nupkg; do
            if [ -f "$f" ]; then
              sha256sum "$f" > "$f.sha256"
            fi
          done

      - name: Extract release notes
        id: extract_notes
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          VERSION_NO_V="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          if [ -f CHANGELOG.md ]; then
            awk "/^## \[${VERSION_NO_V}\]/,/^## \[/{if (/^## \[${VERSION_NO_V}\]/) f=1; else if (/^## \[/) f=0; if (f && !/^## \[${VERSION_NO_V}\]/) print}" CHANGELOG.md > release_notes.md
          fi
          if [ ! -s release_notes.md ]; then
            git tag -l --format='%(contents)' "$VERSION" > release_notes.md
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: false
          generate_release_notes: true
          body_path: release_notes.md
          fail_on_unmatched_files: false
          files: |
            ${{ env.APP_NAME }}-*
            ${{ env.APP_NAME }}-*.sha256
            Plainpad-*.nupkg
            Setup.exe
            Setup.exe.sha256
            RELEASES
            RELEASES.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
